<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Pyodide</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>
  </head>
  <body>
    <textarea id="input" cols="80" rows="35">
print("Hello, World!")

import random
print("Random number: ", random.randint(1, 10))

import numpy
array =  numpy.array([1, 2, 3])
print("Numpy:", numpy.sin(array))

#import turtle
#t = turtle.Turtle()
#t.forward(100)

#from p5 import *
#def setup():
#    createCanvas(400, 200)
#def draw():
#    color = frameCount % 255
#    background(color, color, 255 - color)
#run()

import pygal
bar_chart = pygal.Bar()
bar_chart.add("Fibonacci", [1, 1, 2, 3, 5])
bar_chart.render()

import sqlite3
conn = sqlite3.connect("sports_club.sqlite")
rows = conn.execute("select FirstName from Member").fetchall()
print(rows)

from complex import Complex
print("Complex:", Complex(2, 3) + Complex(4, 5))

import sense_hat
    </textarea>

    <br/>
    <button id="run" disabled>Run</button>

    <pre id="output">Loading pyodide...</pre>
    <div id="visual" style="width: fit-content;"></div>

    <script type="module">
      import * as pygal from "./packages/pygal.js";
      import * as _internal_sense_hat from "./packages/_internal_sense_hat.js";

      const runButton = document.getElementById("run");
      const input = document.getElementById("input");
      const output = document.getElementById("output");
      const visual = document.getElementById("visual");

      let pyodide;

      const main = async () => {
        pyodide = await loadPyodide(pyodideConfig);
        pyodide.registerJsModule("basthon", fakeBasthonPackage);

        runButton.disabled = false;
        output.innerHTML = "";
      };

      const pyodideConfig = {
        stdout: (text) => output.innerHTML += text + "\n",
        // TODO: should we use fullStdLib: true ?
      };

      const fakeBasthonPackage = {
        kernel: {
          display_event: (e) => showVisual(e.toJs().get("content")),
          locals: () => pyodide.runPython("globals()"),
        },
      };

      const showVisual = (element) => {
        if (!element) { return; }

        if (element instanceof SVGElement) {
          // Animations won't play if we append the svg.
          visual.innerHTML = element.outerHTML;
        } else if (typeof element === "string") {
          visual.innerHTML = element;
        } else {
          visual.innerHTML = "";
          visual.appendChild(element);
        }

        return visual.firstChild;
      };

      const run = async () => {
        output.innerHTML = "";

        try {
          await withSupportForPackages(async () => {
            await pyodide.loadPackagesFromImports(input.value);
            await pyodide.runPython(input.value);
          });
        } catch (error) {
          console.log(error);
        }
      };

      const withSupportForPackages = async (runPythonFn) => {
        const imports = await pyodide._api.pyodide_code.find_imports(input.value).toJs(); // TODO: use public API

        for (name of imports) {
          await loadDependency(name);
        }

        await runPythonFn();

        for (name of imports) {
          await vendoredPackages[name]?.after();
        }
      };

      let micropip;

      const loadDependency = async (name) => {
        // If the import is for a vendored package then run its .before() hook.
        const vendoredPackage = vendoredPackages[name];
        await vendoredPackage?.before();
        if (vendoredPackage) { return; }

        // If the import is for a module built into Python then do nothing.
        let pythonModule;
        try { pythonModule = pyodide.pyimport(name); } catch(_) { }
        if (pythonModule) { return; }

        // If the import is for a package built into Pyodide then load it.
        // Built-ins: https://pyodide.org/en/stable/usage/packages-in-pyodide.html
        await pyodide.loadPackage(name).catch(() => {});
        let pyodidePackage;
        try { pyodidePackage = pyodide.pyimport(name); } catch(_) { }
        if (pyodidePackage) { return; }

        // Ensure micropip is loaded which can fetch packages from PyPi.
        // See: https://pyodide.org/en/stable/usage/loading-packages.html
        if (!micropip) {
          await pyodide.loadPackage("micropip");
          micropip = pyodide.pyimport("micropip");
        }

        // If the import is for a PyPi package then load it.
        // Otherwise, don't error now so that we get an error later from Python.
        await micropip.install(name).catch(() => {});
      };

      const vendoredPackages = {
        turtle: {
          before: () => pyodide.loadPackage("./packages/turtle-0.0.1-py3-none-any.whl"),
          after: () => pyodide.runPython(`
            import turtle
            import basthon

            svg = turtle.Screen().show_scene()
            basthon.kernel.display_event({ "display_type": "turtle", "content": svg })
            turtle.restart()
          `),
        },
        p5: {
          before: () => pyodide.loadPackage(["setuptools", "./packages/p5-0.0.1-py3-none-any.whl"]),
          after: () => {},
        },
        pygal: {
          before: () => {
            pyodide.registerJsModule("pygal", { ...pygal });
            pygal.config.domOutput = (html) => showVisual(html);
          },
          after: () => {},
        },
        sqlite3: {
          before: async () => {
            const response = await fetch("https://cdn.adacomputerscience.org/ada/example_databases/sports_club.sqlite");
            const buffer = await response.arrayBuffer();

            pyodide.FS.writeFile("sports_club.sqlite", new Uint8Array(buffer));
          },
          after: () => {},
        },
        sense_hat: {
          before: async () => {
            pyodide.registerJsModule("_internal_sense_hat", { ..._internal_sense_hat });
            await pyodide.loadPackage(["pillow", "./packages/sense_hat-0.0.1-py3-none-any.whl"]);
            _internal_sense_hat.config.pyodide = pyodide;
          },
          after: () => {},
        }
      };

      main();
      runButton.addEventListener("click", run);
    </script>
  </body>
</html>
