<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Pyodide</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
  </head>
  <body>
    <textarea id="input" cols="80" rows="15">
print("Hello, World!")

import random
print("Random number: ", random.randint(1, 10))

import numpy
array =  numpy.array([1, 2, 3])
print("Numpy: ", numpy.sin(array))

import turtle
t = turtle.Turtle()
t.forward(100)
    </textarea>

    <br/>
    <button id="run" onclick="run()" disabled>Run</button>

    <pre id="output">Loading pyodide...</pre>
    <div id="visual"></div>

    <script type="text/javascript">
      const runButton = document.getElementById("run");
      const input = document.getElementById("input");
      const output = document.getElementById("output");

      let pyodide;

      const main = async () => {
        pyodide = await loadPyodide({
          stdout: (text) => output.innerHTML += text + "\n",
          // TODO: should we use fullStdLib: true ?
        });

        runButton.disabled = false;
        output.innerHTML = "";
      };
      main();

      const run = async () => {
        output.innerHTML = "";

        try {
          await withTurtleSupport(async () => {
            await pyodide.loadPackagesFromImports(input.value);
            await pyodide.runPython(input.value);
          });
        } catch (error) {
          console.log(error);
        }
      };

      const withTurtleSupport = async (runPythonFn) => {
        const turtleNeeded = input.value.includes("import turtle");
        if (!turtleNeeded) { return runPythonFn(); }

        await pyodide.loadPackage("./packages/turtle-0.0.1-py3-none-any.whl");
        await runPythonFn();
        await pyodide.runPython(`
          import turtle
          from js import document

          turtle.Screen().show_scene()
          document.getElementById("visual").innerHTML = turtle.svg()
        `);
      };
    </script>
  </body>
</html>
