<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Pyodide</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    <script src="https://code.highcharts.com/highcharts.js"></script>
  </head>
  <body>
    <textarea id="input" cols="80" rows="25">
print("Hello, World!")

import random
print("Random number: ", random.randint(1, 10))

import numpy
array =  numpy.array([1, 2, 3])
print("Numpy: ", numpy.sin(array))

#import turtle
#t = turtle.Turtle()
#t.forward(100)

from p5 import *
def setup():
    createCanvas(400, 200)
def draw():
    color = frameCount % 255
    background(color, color, 255 - color)
run()

import pygal
bar_chart = pygal.Bar()
bar_chart.add("Fibonacci", [1, 1, 2, 3, 5])
bar_chart.render()
    </textarea>

    <br/>
    <button id="run" disabled>Run</button>

    <pre id="output">Loading pyodide...</pre>
    <div id="visual" style="width: fit-content;"></div>

    <script type="module">
      import * as pygal from "../../pygal.js/pygal.js";

      const runButton = document.getElementById("run");
      const input = document.getElementById("input");
      const output = document.getElementById("output");
      const visual = document.getElementById("visual");

      let pyodide;

      const main = async () => {
        pyodide = await loadPyodide(pyodideConfig);

        await pyodide.registerJsModule("basthon", fakeBasthonPackage);
        await pyodide.registerJsModule("pygal", { ...pygal });

        pygal.config.domOutput = (html) => showVisual(html);

        runButton.disabled = false;
        output.innerHTML = "";
      };

      const pyodideConfig = {
        stdout: (text) => output.innerHTML += text + "\n",
        // TODO: should we use fullStdLib: true ?
      };

      const fakeBasthonPackage = {
        kernel: {
          display_event: (e) => showVisual(e.toJs().get("content")),
          locals: () => pyodide.runPython("globals()"),
        },
      };

      const showVisual = (element) => {
        if (!element) { return; }

        if (element instanceof SVGElement) {
          // Animations won't play if we append the svg.
          visual.innerHTML = element.outerHTML;
        } else if (typeof element === "string") {
          visual.innerHTML = element;
        } else {
          visual.innerHTML = "";
          visual.appendChild(element);
        }

        return visual.firstChild;
      };

      const run = async () => {
        output.innerHTML = "";

        try {
          await withSupportForVendoredPackages(async () => {
            await pyodide.loadPackagesFromImports(input.value);
            await pyodide.runPython(input.value);
          });
        } catch (error) {
          console.log(error);
        }
      };

      const withSupportForVendoredPackages = async (runPythonFn) => {
        const imports = await pyodide._api.pyodide_code.find_imports(input.value).toJs(); // TOOD: use public API

        for (name of imports) {
          await vendoredPackages[name]?.before();
        }

        await runPythonFn();

        for (name of imports) {
          await vendoredPackages[name]?.after();
        }
      };

      const vendoredPackages = {
        turtle: {
          before: () => pyodide.loadPackage("./packages/turtle-0.0.1-py3-none-any.whl"),
          after: () => pyodide.runPython(`
            import turtle
            import basthon

            svg = turtle.Screen().show_scene()
            basthon.kernel.display_event({ "display_type": "turtle", "content": svg })
            turtle.restart()
          `),
        },
        p5: {
          before: () => pyodide.loadPackage(["setuptools", "./packages/p5-0.0.1-py3-none-any.whl"]),
          after: () => {},
        },
      };

      main();
      runButton.addEventListener("click", run);
    </script>
  </body>
</html>
