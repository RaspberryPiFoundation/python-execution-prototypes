<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Pyodide</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
  </head>
  <body>
    <textarea id="input" cols="80" rows="15">
print("Hello, World!")

import random
print("Random number: ", random.randint(1, 10))

import numpy
array =  numpy.array([1, 2, 3])
print("Numpy: ", numpy.sin(array))

import turtle
t = turtle.Turtle()
t.forward(100)

import p5
    </textarea>

    <br/>
    <button id="run" onclick="run()" disabled>Run</button>

    <pre id="output">Loading pyodide...</pre>
    <div id="visual" style="width: fit-content;"></div>

    <script type="text/javascript">
      const runButton = document.getElementById("run");
      const input = document.getElementById("input");
      const output = document.getElementById("output");
      const visual = document.getElementById("visual");

      let pyodide;

      const main = async () => {
        pyodide = await loadPyodide(pyodideConfig);
        await pyodide.registerJsModule("basthon", fakeBasthonPackage);

        runButton.disabled = false;
        output.innerHTML = "";
      };

      const pyodideConfig = {
        stdout: (text) => output.innerHTML += text + "\n",
        // TODO: should we use fullStdLib: true ?
      };

      const fakeBasthonPackage = {
        kernel: {
          display_event: (pyEvent) => {
            const jsEvent = Object.fromEntries(pyEvent.toJs());

            if (jsEvent.content) {
              visual.innerHTML = "";
              visual.appendChild(jsEvent.content);
            }
          },
          locals: () => pyodide.runPython("globals()"),
        },
      };

      const run = async () => {
        output.innerHTML = "";

        try {
          await withSupportForVendoredPackages(async () => {
            await pyodide.loadPackagesFromImports(input.value);
            await pyodide.runPython(input.value);
          });
        } catch (error) {
          console.log(error);
        }
      };

      const withSupportForVendoredPackages = async (runPythonFn) => {
        const imports = await pyodide._api.pyodide_code.find_imports(input.value).toJs(); // TOOD: use public API

        for (name of imports) {
          await vendoredPackages[name]?.before();
        }

        await runPythonFn();

        for (name of imports) {
          await vendoredPackages[name]?.after();
        }
      };

      const vendoredPackages = {
        turtle: {
          before: () => pyodide.loadPackage("./packages/turtle-0.0.1-py3-none-any.whl"),
          after: () => pyodide.runPython(`
            import turtle
            from js import document

            turtle.Screen().show_scene()
            document.getElementById("visual").innerHTML = turtle.svg()
          `),
        },
        p5: {
          before: () => pyodide.loadPackage(["setuptools", "./packages/p5-0.0.1-py3-none-any.whl"]),
          after: () => {},
        },
      };

      main();
    </script>
  </body>
</html>
